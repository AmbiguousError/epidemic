<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Epidemic Simulator</title>
    
    <style>
        :root {
            --bg-color: #1e1e1e; --panel-bg-color: #252526; --border-color: #3e3e42;
            --text-color: #d4d4d4; --primary-color: #4dc9b0;
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { display: flex; justify-content: center; align-items: center; }
        h2, h3 { font-weight: 300; margin-top: 0; margin-bottom: 1rem; }
        
        .main-container {
            width: 1280px; height: 720px; display: flex;
            border: 1px solid var(--border-color); background-color: var(--panel-bg-color); overflow: hidden;
        }
        
        #simulation-view { 
            width: 100%; height: 100%; display: flex;
        }
        #simulation-canvas { 
            background-color: #0a0a0b; height: 100%; flex-grow: 1;
        }
        #ui-panel {
            width: 380px; flex-shrink: 0; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column;
        }
        #ui-panel h2, #ui-panel h3 { margin-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stats-item { font-size: 0.9em; }
        .key-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.9em; }
        .key-color { width: 15px; height: 15px; margin-right: 8px; border-radius: 2px; }
        #commentary { font-style: italic; color: #aaa; margin-bottom: 15px; min-height: 50px;}
        .chart-container { position: relative; height: 150px; width: 100%; margin-top: auto;}
    </style>
</head>
<body>

    <div class="main-container">
        <!-- The only view is the simulation view -->
        <div id="simulation-view" class="view active">
            <canvas id="simulation-canvas"></canvas>
            <div id="ui-panel">
                <h2>Live Analysis</h2>
                <h3 id="ui-disease-name"></h3>
                <div class="stats-grid">
                    <div class="stats-item" id="ui-elapsed-days">Days: 0</div>
                    <div class="stats-item" id="ui-rt">R(t): 0.00</div>
                    <div class="stats-item" id="ui-total-sick-days">Sick Days: 0</div>
                </div>
                <div id="ui-key"></div>
                <h3>Vaccine Outcomes</h3>
                <div class="stats-grid">
                    <div class="stats-item" id="ui-vax-deaths">Fatalities: 0</div>
                    <div class="stats-item" id="ui-vax-long-term">Long-Term: 0</div>
                </div>
                <h3>Commentary</h3>
                <p id="commentary">Initializing...</p>
                <div class="chart-container"><canvas id="history-chart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Embedded JavaScript Application -->
    <script>
    const App = {
        // =============== CONFIG & STATE ===============
        els: {}, POPULATION_SIZE: 400, AGENT_RADIUS: 5, TICKS_PER_DAY: 60, AVG_CONTACTS_PER_DAY: 8,
        population: [], diseaseParams: {}, simulationRunning: false, history: [],
        ticks: 0, stats: {}, peakInfected: 0, peakReached: false,
        totalSickDays: 0, vaxDeaths: 0, vaxLongTerm: 0, vaccinationCounter: 0, chart: null,

        // =============== INITIALIZATION ===============
        init() {
            this.els = {
                simView: document.getElementById('simulation-view'),
                simCanvas: document.getElementById('simulation-canvas'),
                uiPanel: { 
                    container: document.getElementById('ui-panel'),
                    name: document.getElementById('ui-disease-name'), 
                    days: document.getElementById('ui-elapsed-days'), 
                    rt: document.getElementById('ui-rt'), 
                    sickDays: document.getElementById('ui-total-sick-days'), 
                    key: document.getElementById('ui-key'), 
                    vaxDeaths: document.getElementById('ui-vax-deaths'), 
                    vaxLongTerm: document.getElementById('ui-vax-long-term'), 
                    commentary: document.getElementById('commentary'), 
                    historyChart: document.getElementById('history-chart').getContext('2d'), 
                },
            };
            this.ctx = this.els.simCanvas.getContext('2d');
            this.setDiseaseParameters();
            
            // This guarantees the UI is drawn before we measure the canvas
            requestAnimationFrame(() => { 
                this.resetSimulationState();
                this.simulationRunning = true;
                this.gameLoop();
            });
        },
        
        setDiseaseParameters() {
            // Hardcode a single disease profile to ensure it works
            const defaultProfile = {"R0":2.5,"incubation_days":5,"infectious_days":7,"fatality_rate":0.01,"long_term_effect_rate":0.10,"vaccine_efficacy":0.9,"vaccine_mortality_rate":0.000002,"vaccine_long_term_effect_rate":0.00005,"initial_vax_rate":0.0,"daily_vax_rate":8};
            this.diseaseParams = {
                name: "COVID-19 (Default)", ...defaultProfile
            };
            this.diseaseParams.transmission_prob = this.diseaseParams.R0 / (this.AVG_CONTACTS_PER_DAY * this.diseaseParams.infectious_days);
            this.diseaseParams.incubation_ticks = Math.round(this.diseaseParams.incubation_days * this.TICKS_PER_DAY);
            this.diseaseParams.infectious_ticks = Math.round(this.diseaseParams.infectious_days * this.TICKS_PER_DAY);
        },

        // =============== SIMULATION CONTROL ===============
        resetSimulationState() {
            this.ticks = this.peakInfected = this.totalSickDays = this.vaxDeaths = this.vaxLongTerm = this.vaccinationCounter = 0;
            this.peakReached = false; this.history = [];
            this.resizeCanvas();
            this.population = Array.from({length: this.POPULATION_SIZE}, () => new Agent('S', this.els.simCanvas.width, this.els.simCanvas.height));
            const numToVax = Math.floor(this.POPULATION_SIZE * this.diseaseParams.initial_vax_rate);
            this.population.slice(0, numToVax).forEach(agent => this.vaccinateAgent(agent));
            const patientZero = this.population.find(a => a.state === 'S');
            if(patientZero){ patientZero.state = 'E'; patientZero.timer = this.diseaseParams.incubation_ticks; }
            this.updateStats();
            this.history.push(this.stats.counts);
            this.stats.commentary = "Simulation starting...";
            this.initChart();
        },
        
        // =============== CORE SIMULATION LOOP ===============
        gameLoop() {
            if (!this.simulationRunning) return;
            this.update(); this.render();
            requestAnimationFrame(() => this.gameLoop());
        },
        update() {
            this.ticks++; this.handleVaccinationCampaign(); this.handleInfections();
            this.population.forEach(agent => {
                agent.move(this.els.simCanvas.width, this.els.simCanvas.height);
                agent.update_state(this.diseaseParams);
            });
            this.updateStats();
        },
        render() {
            this.ctx.clearRect(0, 0, this.els.simCanvas.width, this.els.simCanvas.height);
            this.population.forEach(agent => agent.draw(this.ctx));
            this.updateUI();
        },
        
        // =============== SIMULATION LOGIC ===============
        vaccinateAgent(agent) {
            if (agent.state !== 'S') return;
            if (Math.random() < this.diseaseParams.vaccine_mortality_rate) { agent.state = 'D'; this.vaxDeaths++; }
            else if (Math.random() < this.diseaseParams.vaccine_long_term_effect_rate) { agent.state = 'R_LONG'; agent.speed *= 0.4; this.vaxLongTerm++; }
            else { agent.state = 'V'; }
        },
        handleVaccinationCampaign() {
            this.vaccinationCounter += this.diseaseParams.daily_vax_rate / this.TICKS_PER_DAY;
            if (this.vaccinationCounter >= 1) {
                const numToVaccinate = Math.floor(this.vaccinationCounter);
                const susceptible = this.population.filter(a => a.state === 'S');
                if(susceptible.length > 0) {
                    for(let i=0; i < Math.min(numToVaccinate, susceptible.length); i++) this.vaccinateAgent(susceptible[i]);
                }
                this.vaccinationCounter -= numToVaccinate;
            }
        },
        handleInfections() {
            const infectious = this.population.filter(a => a.state === 'I');
            if(infectious.length === 0) return;
            const targets = this.population.filter(a => a.state === 'S' || a.state === 'V');
            const vax_prob = this.diseaseParams.transmission_prob * (1 - this.diseaseParams.vaccine_efficacy);
            for (const infector of infectious) {
                for (const target of targets) {
                    if (target.state === 'S' || target.state === 'V') {
                        const distSq = (infector.x - target.x)**2 + (infector.y - target.y)**2;
                        if (distSq < (this.AGENT_RADIUS * 4)**2) {
                            const prob = target.state === 'S' ? this.diseaseParams.transmission_prob : vax_prob;
                            if (Math.random() < prob) { target.state = 'E'; target.timer = this.diseaseParams.incubation_ticks; }
                        }
                    }
                }
            }
        },
        
        // =============== UI & CANVAS & CHART ===============
        resizeCanvas() {
            const panelWidth = this.els.uiPanel.container.offsetWidth;
            this.els.simCanvas.width = this.els.simView.offsetWidth - panelWidth;
            this.els.simCanvas.height = this.els.simView.offsetHeight;
        },
        updateUI() {
            this.els.uiPanel.name.textContent = this.diseaseParams.name;
            this.els.uiPanel.days.textContent = `Days: ${this.stats.elapsed_days}`;
            this.els.uiPanel.rt.textContent = `R(t): ${this.stats.Rt.toFixed(2)}`;
            this.els.uiPanel.sickDays.textContent = `Sick Days: ${Math.floor(this.totalSickDays)}`;
            this.els.uiPanel.vaxDeaths.textContent = `Fatalities: ${this.vaxDeaths}`;
            this.els.uiPanel.vaxLongTerm.textContent = `Long-Term: ${this.vaxLongTerm}`;
            this.els.uiPanel.commentary.textContent = this.stats.commentary;
            let keyHTML = '';
            for(const state in this.stats.counts) {
                const count = this.stats.counts[state];
                const percent = ((count / this.POPULATION_SIZE) * 100).toFixed(1);
                const color = AGENT_COLORS[state];
                keyHTML += `<div class="key-item"><div class="key-color" style="background-color:${color};"></div> ${STATE_NAMES[state]}: ${count} (${percent}%)</div>`;
            }
            this.els.uiPanel.key.innerHTML = keyHTML;
            if (this.ticks > 0 && this.ticks % this.TICKS_PER_DAY === 0) this.updateChart();
        },
        initChart() {
            if (this.chart) this.chart.destroy();
            const datasets = Object.keys(AGENT_COLORS).map(key => ({
                label: STATE_NAMES[key], data: [], backgroundColor: AGENT_COLORS[key],
                borderColor: AGENT_COLORS[key], fill: true, pointRadius: 0
            }));
            this.chart = new Chart(this.els.uiPanel.historyChart, {
                type: 'line', data: { labels: [], datasets: datasets },
                options: { animation: false, responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        },
        updateChart() {
            this.chart.data.labels = this.history.map((_, i) => i);
            this.chart.data.datasets.forEach(dataset => {
                const key = Object.keys(STATE_NAMES).find(k => STATE_NAMES[k] === dataset.label);
                dataset.data = this.history.map(h => h[key] || 0);
            });
            this.chart.update('none');
        },
        updateStats() {
            const previous_counts = this.stats.counts || {};
            const counts = { S: 0, V: 0, E: 0, I: 0, R_FULL: 0, R_LONG: 0, D: 0 };
            this.population.forEach(a => { counts[a.state]++; });
            const effectiveSusceptible = counts.S + (counts.V * (1 - this.diseaseParams.vaccine_efficacy));
            const Rt = this.diseaseParams.R0 * (effectiveSusceptible / this.POPULATION_SIZE);
            this.totalSickDays += counts.I / this.TICKS_PER_DAY;
            const commentary = this.getCommentary(counts, previous_counts);
            this.stats = { counts, elapsed_days: Math.floor(this.ticks / this.TICKS_PER_DAY), Rt, commentary };
            if (this.ticks > 0 && this.ticks % this.TICKS_PER_DAY === 0) this.history.push(this.stats.counts);
            if(commentary === "The epidemic has ended.") this.simulationRunning = false;
        },
        getCommentary(current, prev){
            const current_I = current.I || 0; const prev_I = prev.I || 0;
            if(current_I > this.peakInfected) this.peakInfected = current_I;
            if (current_I > 0 && prev_I === 0) return "The outbreak has begun.";
            if (current_I > prev_I && !this.peakReached) return `Exponential growth phase. R(t) is ${this.stats.Rt.toFixed(2)}.`;
            if (current_I < prev_I && !this.peakReached && current_I > 0) {
                this.peakReached = true; return `Outbreak has peaked with ${this.peakInfected} infected.`;
            }
            if(this.peakReached && current_I > 0) return "The outbreak is receding due to immunity and vaccinations.";
            if(current_I === 0 && current.E === 0 && this.ticks > 100) return `The epidemic has ended.`;
            return this.stats.commentary || "Simulation in progress...";
        }
    };

    // =============== JAVASCRIPT AGENT CLASS ===============
    const AGENT_COLORS = {S: '#9696ff', V: '#c896ff', E: '#ffff64', I: '#ff3232', R_FULL: '#32c832', R_LONG: '#006400', D: '#505050'};
    const STATE_NAMES = {S: 'Susceptible', V: 'Vaccinated', E: 'Exposed', I: 'Infectious', R_FULL: 'Recovered (Full)', R_LONG: 'Recovered (Long)', D: 'Deceased'};

    class Agent {
        constructor(state, width, height) {
            this.x = Math.random() * width; this.y = Math.random() * height;
            this.radius = App.AGENT_RADIUS; this.state = state; this.timer = 0;
            const angle = Math.random() * 2 * Math.PI; this.speed = 0.5 + Math.random();
            this.dx = Math.cos(angle) * this.speed; this.dy = Math.sin(angle) * this.speed;
        }
        move(width, height) {
            if (this.state === 'D') return;
            this.x += this.dx; this.y += this.dy;
            if (this.x <= this.radius || this.x >= width - this.radius) this.dx *= -1;
            if (this.y <= this.radius || this.y >= height - this.radius) this.dy *= -1;
        }
        update_state(diseaseParams) {
            if (this.state === 'E' || this.state === 'I') {
                this.timer--;
                if (this.timer <= 0) {
                    if (this.state === 'E') { this.state = 'I'; this.timer = diseaseParams.infectious_ticks; }
                    else if (this.state === 'I') {
                        if (Math.random() < diseaseParams.fatality_rate) this.state = 'D';
                        else if (Math.random() < diseaseParams.long_term_effect_rate) { this.state = 'R_LONG'; this.speed *= 0.4; }
                        else this.state = 'R_FULL';
                    }
                }
            }
        }
        draw(ctx) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
            ctx.fillStyle = AGENT_COLORS[this.state];
            ctx.fill();
        }
    }
    
    // =============== START THE APP ===============
    document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
